<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:Storyboard.ViewModels"
        x:Class="Storyboard.Views.BatchOperationsDialog"
        x:DataType="vm:BatchOperationsViewModel"
        Title="批量操作"
        Width="1100"
        Height="650"
        WindowStartupLocation="CenterOwner"
        Background="#0a0a0a"
        CanResize="False">

    <Grid RowDefinitions="Auto,*,Auto" Margin="24">

        <!-- Header -->
        <StackPanel Grid.Row="0" Margin="0,0,0,16">
            <TextBlock Text="批量操作"
                       FontSize="20"
                       FontWeight="SemiBold"
                       Foreground="#f5f5f5" />
        </StackPanel>

        <!-- Content -->
        <Grid Grid.Row="1" ColumnDefinitions="*,*">

            <!-- Left: Shot selection + operations -->
            <Grid Grid.Column="0" Margin="0,0,12,0" RowDefinitions="Auto,*,Auto,Auto">

                <Grid Grid.Row="0" ColumnDefinitions="*,Auto,Auto" Margin="0,0,0,16">
                    <TextBlock Grid.Column="0"
                               Text="选择分镜"
                               FontSize="14"
                               FontWeight="SemiBold"
                               Foreground="#f5f5f5"
                               VerticalAlignment="Center" />
                    <Button Grid.Column="1"
                            Classes="Ghost"
                            Content="全选"
                            Margin="0,0,8,0"
                            Command="{Binding SelectAllCommand}" />
                    <Button Grid.Column="2"
                            Classes="Ghost"
                            Content="取消"
                            Command="{Binding DeselectAllCommand}" />
                </Grid>

                <Border Grid.Row="1"
                        Background="#0a0a0a"
                        BorderBrush="#27272a"
                        BorderThickness="1"
                        CornerRadius="8"
                    Padding="12"
                    Margin="0,0,0,16">
                    <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
                        <ItemsControl ItemsSource="{Binding Shots}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border Padding="10"
                                            Margin="0,0,0,8"
                                            Background="#18181b"
                                            BorderBrush="#27272a"
                                            BorderThickness="1"
                                            CornerRadius="8">
                                        <StackPanel Orientation="Horizontal" Spacing="10">
                                            <CheckBox IsChecked="{Binding IsChecked}" VerticalAlignment="Center" />
                                            <StackPanel Spacing="2">
                                                <TextBlock FontWeight="SemiBold" Foreground="#f5f5f5">
                                                    <Run Text="分镜 #" />
                                                    <Run Text="{Binding ShotNumber}" />
                                                </TextBlock>
                                                <TextBlock Text="{Binding CoreContent}"
                                                           FontSize="12"
                                                           Foreground="#a1a1aa"
                                                           TextTrimming="CharacterEllipsis" />
                                            </StackPanel>
                                        </StackPanel>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>
                </Border>

                <StackPanel Grid.Row="2" Spacing="8" Margin="0,0,0,16">
                    <TextBlock Text="选择操作"
                               FontSize="14"
                               FontWeight="SemiBold"
                               Foreground="#f5f5f5" />
                    <Border Background="#0a0a0a"
                            BorderBrush="#27272a"
                            BorderThickness="1"
                            CornerRadius="8"
                            Padding="12">
                        <StackPanel Spacing="10">
                            <CheckBox IsChecked="{Binding Parse}" Content="AI 解析" Foreground="#f5f5f5" />
                            <CheckBox IsChecked="{Binding ImageFirst}" Content="生成首帧图" Foreground="#f5f5f5" />
                            <CheckBox IsChecked="{Binding ImageLast}" Content="生成尾帧图" Foreground="#f5f5f5" />
                            <CheckBox IsChecked="{Binding Video}" Content="生成视频" Foreground="#f5f5f5" />
                        </StackPanel>
                    </Border>
                </StackPanel>

                <Button Grid.Row="3"
                        Classes="Primary"
                        HorizontalAlignment="Stretch"
                        Command="{Binding StartCommand}"
                        IsEnabled="{Binding CanStart}">
                    <Grid>
                        <TextBlock Text="执行中..." IsVisible="{Binding IsRunning}" />
                        <TextBlock Text="开始批量操作" IsVisible="{Binding IsRunning, Converter={StaticResource BoolNot}}" />
                    </Grid>
                </Button>

            </Grid>

            <!-- Right: Progress -->
            <Grid Grid.Column="1" Margin="12,0,0,0" RowDefinitions="Auto,Auto,*">

                <Grid Grid.Row="0" ColumnDefinitions="*,Auto" Margin="0,0,0,16">
                    <TextBlock Grid.Column="0"
                               Text="执行进度"
                               FontSize="14"
                               FontWeight="SemiBold"
                               Foreground="#f5f5f5"
                               VerticalAlignment="Center" />
                    <TextBlock Grid.Column="1"
                               Text="{Binding CompletedTasksText}"
                               Foreground="#a1a1aa"
                               VerticalAlignment="Center"
                               IsVisible="{Binding HasTasks}" />
                </Grid>

                <StackPanel Grid.Row="1" Spacing="6" IsVisible="{Binding HasTasks}" Margin="0,0,0,16">
                    <ProgressBar Minimum="0" Maximum="100" Value="{Binding OverallProgressPercent}" Height="6" />
                    <TextBlock Text="{Binding OverallProgressText}" FontSize="12" Foreground="#a1a1aa" HorizontalAlignment="Center" />
                </StackPanel>

                <Border Grid.Row="2"
                        Background="#0a0a0a"
                        BorderBrush="#27272a"
                        BorderThickness="1"
                        CornerRadius="8"
                        Padding="12">
                    <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
                        <Grid>
                            <TextBlock Text="选择分镜和操作后&#10;点击开始执行"
                                       Foreground="#71717a"
                                       HorizontalAlignment="Center"
                                       VerticalAlignment="Center"
                                       TextAlignment="Center"
                                       IsVisible="{Binding HasTasks, Converter={StaticResource BoolNot}}" />

                            <ItemsControl ItemsSource="{Binding Tasks}" IsVisible="{Binding HasTasks}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border Background="#18181b"
                                                BorderBrush="#27272a"
                                                BorderThickness="1"
                                                CornerRadius="8"
                                                Padding="12"
                                                Margin="0,0,0,8">
                                            <StackPanel Spacing="8">
                                                <Grid ColumnDefinitions="*,Auto">
                                                    <TextBlock Grid.Column="0" Text="{Binding Title}" Foreground="#f5f5f5" FontWeight="SemiBold" />
                                                    <Border Grid.Column="1" Background="#27272a" CornerRadius="12" Padding="10,3">
                                                        <TextBlock Text="{Binding StatusText}" FontSize="12" Foreground="#e4e4e7" />
                                                    </Border>
                                                </Grid>
                                                <ProgressBar Minimum="0" Maximum="100" Value="{Binding Progress}" Height="4" IsVisible="{Binding IsRunning}" />
                                            </StackPanel>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </Grid>
                    </ScrollViewer>
                </Border>

            </Grid>
        </Grid>

        <!-- Footer -->
        <Grid Grid.Row="2" ColumnDefinitions="*,Auto" Margin="0,16,0,0">
            <TextBlock Grid.Column="0" VerticalAlignment="Center">
                <Run Text="已选择 " Foreground="#a1a1aa" />
                <Run Text="{Binding SelectedShotsCountText}" Foreground="#f5f5f5" FontWeight="SemiBold" />
            </TextBlock>
            <Button Grid.Column="1" Classes="Secondary" Content="关闭" Width="100" Command="{Binding CancelCommand}" />
        </Grid>

    </Grid>
</Window>


using Avalonia.Controls;
using Storyboard.ViewModels;
using System;

namespace Storyboard.Views;

public partial class BatchOperationsDialog : Window
{
    public BatchOperationsDialog()
    {
        InitializeComponent();
        DataContextChanged += OnDataContextChanged;
    }

    private void OnDataContextChanged(object? sender, EventArgs e)
    {
        if (DataContext is BatchOperationsViewModel vm)
        {
            vm.RequestClose -= Vm_RequestClose;
            vm.RequestClose += Vm_RequestClose;
        }
    }

    private void Vm_RequestClose(object? sender, EventArgs e)
    {
        Close();
    }
}


using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using Storyboard.Models;
using System;
using System.Collections.ObjectModel;
using System.Collections.Specialized;
using System.ComponentModel;
using System.Linq;
using System.Threading;
using System.Threading.Tasks;

namespace Storyboard.ViewModels;

public enum BatchOperationKind
{
    Parse,
    ImageFirst,
    ImageLast,
    Video
}

public partial class BatchTaskViewModel : ObservableObject
{
    public GenerationJob Job { get; }
    public BatchOperationKind Operation { get; }

    public BatchTaskViewModel(GenerationJob job, BatchOperationKind operation)
    {
        Job = job;
        Operation = operation;
        Job.PropertyChanged += Job_PropertyChanged;
    }

    public int ShotNumber => Job.ShotNumber ?? 0;

    public string OperationName => Operation switch
    {
        BatchOperationKind.Parse => "AI 解析",
        BatchOperationKind.ImageFirst => "生成首帧",
        BatchOperationKind.ImageLast => "生成尾帧",
        BatchOperationKind.Video => "生成视频",
        _ => "未知"
    };

    public string Title => $"分镜 #{ShotNumber} - {OperationName}";

    public string StatusText => Job.StatusText;

    public bool IsRunning => Job.Status is GenerationJobStatus.Queued or GenerationJobStatus.Running or GenerationJobStatus.Retrying;
    public bool IsCompleted => Job.Status is GenerationJobStatus.Succeeded;
    public bool IsFailed => Job.Status is GenerationJobStatus.Failed or GenerationJobStatus.Canceled;
    public int Progress => (int)Math.Round(Job.Progress * 100);

    private void Job_PropertyChanged(object? sender, PropertyChangedEventArgs e)
    {
        if (e.PropertyName is nameof(GenerationJob.Status)
            or nameof(GenerationJob.Progress))
        {
            OnPropertyChanged(nameof(StatusText));
            OnPropertyChanged(nameof(IsRunning));
            OnPropertyChanged(nameof(IsCompleted));
            OnPropertyChanged(nameof(IsFailed));
            OnPropertyChanged(nameof(Progress));
        }
    }
}

public partial class BatchOperationsViewModel : ObservableObject
{
    private readonly MainViewModel _mainViewModel;

    public ObservableCollection<ShotItem> Shots { get; }

    public ObservableCollection<BatchTaskViewModel> Tasks { get; } = new();

    [ObservableProperty]
    private bool parse = true;

    [ObservableProperty]
    private bool imageFirst = true;

    [ObservableProperty]
    private bool imageLast = true;

    [ObservableProperty]
    private bool video;

    partial void OnParseChanged(bool value) => RaiseSelectionDependent();
    partial void OnImageFirstChanged(bool value) => RaiseSelectionDependent();
    partial void OnImageLastChanged(bool value) => RaiseSelectionDependent();
    partial void OnVideoChanged(bool value) => RaiseSelectionDependent();

    [ObservableProperty]
    private bool isRunning;

    public BatchOperationsViewModel(MainViewModel mainViewModel)
    {
        _mainViewModel = mainViewModel;
        Shots = mainViewModel.Shots;

        Shots.CollectionChanged += Shots_CollectionChanged;
        foreach (var shot in Shots)
        {
            shot.PropertyChanged += Shot_PropertyChanged;
        }
    }

    public event EventHandler? RequestClose;

    public int SelectedShotsCount => Shots.Count(s => s.IsChecked);
    public bool HasSelectedShots => SelectedShotsCount > 0;
    public string SelectedShotsCountText => $"{SelectedShotsCount} / {Shots.Count}";

    public int CompletedTasksCount => Tasks.Count(t => t.IsCompleted);
    public int TotalTasksCount => Tasks.Count;

    public bool HasTasks => TotalTasksCount > 0;

    public double OverallProgressPercent => TotalTasksCount == 0
        ? 0
        : (double)CompletedTasksCount / TotalTasksCount * 100;

    public string OverallProgressText => TotalTasksCount == 0
        ? ""
        : $"总体进度: {Math.Round(OverallProgressPercent)}%";

    public string CompletedTasksText => TotalTasksCount == 0
        ? ""
        : $"{CompletedTasksCount} / {TotalTasksCount}";

    public bool HasOperationsSelected => Parse || ImageFirst || ImageLast || Video;
    public bool CanStart => !IsRunning && HasSelectedShots && HasOperationsSelected;

    [RelayCommand]
    private void SelectAll()
    {
        foreach (var shot in Shots)
        {
            shot.IsChecked = true;
        }
        RaiseSelectionDependent();
    }

    [RelayCommand]
    private void DeselectAll()
    {
        foreach (var shot in Shots)
        {
            shot.IsChecked = false;
        }
        RaiseSelectionDependent();
    }

    [RelayCommand]
    private void Cancel()
    {
        foreach (var task in Tasks)
        {
            if (task.Job.CanCancel)
                _mainViewModel.CancelJobCommand.Execute(task.Job);
        }
        RequestClose?.Invoke(this, EventArgs.Empty);
    }

    [RelayCommand]
    private async Task StartAsync()
    {
        if (!CanStart)
            return;

        IsRunning = true;
        try
        {
            Tasks.Clear();

            var selectedShots = Shots.Where(s => s.IsChecked).ToList();
            if (!Parse && !ImageFirst && !ImageLast && !Video)
            {
                IsRunning = false;
                RaiseSelectionDependent();
                return;
            }
            AiWriteMode? writeMode = null;
            if (Parse && selectedShots.Any(_mainViewModel.NeedsAiWriteModeForBatch))
            {
                writeMode = await _mainViewModel.PromptAiWriteModeAsync();
                if (writeMode == null)
                {
                    IsRunning = false;
                    RaiseSelectionDependent();
                    return;
                }
            }

            foreach (var shot in selectedShots)
            {
                if (Parse)
                {
                    var job = _mainViewModel.QueueAiParse(shot, writeMode);
                    Tasks.Add(new BatchTaskViewModel(job, BatchOperationKind.Parse));
                }
                if (ImageFirst)
                {
                    var job = _mainViewModel.QueueFirstFrame(shot);
                    Tasks.Add(new BatchTaskViewModel(job, BatchOperationKind.ImageFirst));
                }
                if (ImageLast)
                {
                    var job = _mainViewModel.QueueLastFrame(shot);
                    Tasks.Add(new BatchTaskViewModel(job, BatchOperationKind.ImageLast));
                }
                if (Video && shot.CanGenerateVideo)
                {
                    var job = _mainViewModel.QueueVideo(shot);
                    Tasks.Add(new BatchTaskViewModel(job, BatchOperationKind.Video));
                }
            }

            foreach (var task in Tasks)
                task.PropertyChanged += (_, __) => RaiseTaskDependent();

            RaiseTaskDependent();

            // Stay running until all tasks are finished.
            _ = Task.Run(async () =>
            {
                while (Tasks.Any(t => t.IsRunning))
                {
                    await Task.Delay(200);
                }

                OnUi(() =>
                {
                    IsRunning = false;
                    RaiseSelectionDependent();
                });
            });
        }
        finally
        {
            RaiseSelectionDependent();
        }
    }

    private void Shots_CollectionChanged(object? sender, NotifyCollectionChangedEventArgs e)
    {
        if (e.OldItems is not null)
        {
            foreach (var item in e.OldItems.OfType<ShotItem>())
            {
                item.PropertyChanged -= Shot_PropertyChanged;
            }
        }
        if (e.NewItems is not null)
        {
            foreach (var item in e.NewItems.OfType<ShotItem>())
            {
                item.PropertyChanged += Shot_PropertyChanged;
            }
        }

        RaiseSelectionDependent();
    }

    private void Shot_PropertyChanged(object? sender, PropertyChangedEventArgs e)
    {
        if (e.PropertyName == nameof(ShotItem.IsChecked))
        {
            RaiseSelectionDependent();
        }
    }

    private void RaiseSelectionDependent()
    {
        OnPropertyChanged(nameof(SelectedShotsCount));
        OnPropertyChanged(nameof(HasSelectedShots));
        OnPropertyChanged(nameof(SelectedShotsCountText));
        OnPropertyChanged(nameof(HasOperationsSelected));
        OnPropertyChanged(nameof(CanStart));
    }

    private void RaiseTaskDependent()
    {
        OnPropertyChanged(nameof(CompletedTasksCount));
        OnPropertyChanged(nameof(TotalTasksCount));
        OnPropertyChanged(nameof(HasTasks));
        OnPropertyChanged(nameof(OverallProgressPercent));
        OnPropertyChanged(nameof(OverallProgressText));
        OnPropertyChanged(nameof(CompletedTasksText));
    }

    private static void OnUi(Action action)
    {
        if (Avalonia.Threading.Dispatcher.UIThread.CheckAccess())
        {
            action();
        }
        else
        {
            Avalonia.Threading.Dispatcher.UIThread.Post(action);
        }
    }
}
