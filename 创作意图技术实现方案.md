# 创作意图技术实现方案

## 核心问题
**如何将"创作意图"（创作目标、目标受众、视频基调）与技术实现挂钩？**

---

## 一、技术实现原理

### 1.1 创作意图的作用

创作意图不是一个独立的功能，而是**贯穿整个AI处理流程的上下文信息**。

```
创作意图 → 注入到所有AI Prompt中 → 影响AI的输出结果
```

### 1.2 具体应用场景

| 场景 | 没有创作意图 | 有创作意图 | 效果对比 |
|------|-------------|-----------|---------|
| **视频抽帧分析** | AI只看到画面内容 | AI理解"为什么拍"、"给谁看" | 分析更有针对性 |
| **文本生成分镜** | AI只根据文本生成 | AI根据意图+文本生成 | 分镜更符合目标 |
| **图片生成** | 使用通用风格 | 根据基调调整风格 | 视觉风格统一 |
| **视频生成** | 使用默认参数 | 根据受众调整节奏 | 更符合目标受众 |

---

## 二、数据模型设计

### 2.1 在Project实体中增加字段

**文件：** `Domain/Entities/Project.cs`

```csharp
public class Project
{
    // 现有字段...
    public string Id { get; set; }
    public string Name { get; set; }

    // 新增：创作意图字段
    public string? CreativeGoal { get; set; }        // 创作目标（为什么拍）
    public string? TargetAudience { get; set; }      // 目标受众（给谁看）
    public string? VideoTone { get; set; }           // 视频基调（情绪氛围）
    public string? KeyMessage { get; set; }          // 核心信息（重点是什么）

    // 现有字段...
    public List<Shot> Shots { get; set; }
}
```

### 2.2 创建意图分析结果DTO

**文件：** `Shared/Models/IntentAnalysisResult.cs`

```csharp
/// <summary>
/// 意图分析结果
/// </summary>
public record IntentAnalysisResult(
    string CoreMessage,           // 核心信息（The "Why"）
    string TargetAudience,        // 目标受众（The "Who"）
    string KeyPlotPoints,         // 关键情节点（The "What"）
    string SuggestedTone          // 建议基调（The "How"）
);
```

---

## 三、Prompt工程实现

### 3.1 创作意图如何注入到Prompt中

#### 原理：Prompt模板 + 变量替换

**当前的Prompt模板：**
```
你是一个专业的视频分析师。
请分析这个视频帧，生成分镜描述。

输出格式：JSON
```

**增加创作意图后的Prompt模板：**
```
你是一个专业的视频分析师。

# 项目创作意图
{{IF HAS_CREATIVE_INTENT}}
- 创作目标：{{CREATIVE_GOAL}}
- 目标受众：{{TARGET_AUDIENCE}}
- 视频基调：{{VIDEO_TONE}}
- 核心信息：{{KEY_MESSAGE}}

请在分析时，确保生成的内容符合上述创作意图。
{{ENDIF}}

请分析这个视频帧，生成分镜描述。

输出格式：JSON
```

### 3.2 具体实现代码

**文件：** `Infrastructure/AI/PromptManagementService.cs`

```csharp
public class PromptManagementService
{
    public string RenderPrompt(string templateName, Dictionary<string, string> variables)
    {
        var template = LoadTemplate(templateName);

        // 如果有创作意图，自动注入
        if (variables.ContainsKey("PROJECT_ID"))
        {
            var project = GetProject(variables["PROJECT_ID"]);
            if (HasCreativeIntent(project))
            {
                variables["HAS_CREATIVE_INTENT"] = "true";
                variables["CREATIVE_GOAL"] = project.CreativeGoal;
                variables["TARGET_AUDIENCE"] = project.TargetAudience;
                variables["VIDEO_TONE"] = project.VideoTone;
                variables["KEY_MESSAGE"] = project.KeyMessage;
            }
        }

        return ReplaceVariables(template, variables);
    }

    private bool HasCreativeIntent(Project project)
    {
        return !string.IsNullOrWhiteSpace(project.CreativeGoal)
            || !string.IsNullOrWhiteSpace(project.TargetAudience)
            || !string.IsNullOrWhiteSpace(project.VideoTone);
    }
}
```

---

## 四、具体应用场景实现

### 场景1：视频抽帧后的AI分析

#### 4.1 用户操作流程
```
1. 用户填写创作意图：
   - 创作目标：制作一个科技产品宣传片
   - 目标受众：25-35岁的科技爱好者
   - 视频基调：专业、现代、充满科技感

2. 用户导入视频 → 抽帧

3. 用户点击"批量AI分析"
```

#### 4.2 技术实现

**文件：** `Infrastructure/AI/AIServiceManager.cs`

```csharp
public async Task<AiShotDescription> AnalyzeShotAsync(
    AiShotAnalysisRequest request,
    Project project,  // 新增：传入项目信息
    CancellationToken ct)
{
    // 构建Prompt变量
    var variables = new Dictionary<string, string>
    {
        {"IMAGE_PATH", request.MaterialImagePath},
        {"PROJECT_ID", project.Id}  // 自动注入创作意图
    };

    // 渲染Prompt（会自动注入创作意图）
    var prompt = _promptService.RenderPrompt("shot_analysis", variables);

    // 调用AI
    var result = await _aiProvider.AnalyzeImageAsync(prompt, request.MaterialImagePath, ct);

    return result;
}
```

#### 4.3 Prompt模板示例

**文件：** `Infrastructure/AI/Prompts/shot_analysis.txt`

```
你是一个专业的视频分析师和分镜师。

{{IF HAS_CREATIVE_INTENT}}
# 项目创作意图
本项目的创作背景：
- 创作目标：{{CREATIVE_GOAL}}
- 目标受众：{{TARGET_AUDIENCE}}
- 视频基调：{{VIDEO_TONE}}
- 核心信息：{{KEY_MESSAGE}}

请在分析时，确保生成的分镜描述、镜头语言、视觉风格都符合上述创作意图。
例如：
- 如果基调是"专业、现代"，则使用稳定的镜头、简洁的构图
- 如果受众是"年轻人"，则可以使用更动感的运镜
- 如果目标是"产品宣传"，则重点突出产品特性
{{ENDIF}}

请分析这个视频帧，生成结构化的分镜描述。

输出JSON格式：
{
  "shotType": "镜头类型",
  "coreContent": "核心内容",
  "firstFramePrompt": "首帧提示词",
  "lastFramePrompt": "尾帧提示词",
  "composition": "构图方式",
  "lightingType": "灯光类型",
  "cameraMovement": "运镜方式",
  ...
}
```

#### 4.4 效果对比

**没有创作意图：**
```json
{
  "shotType": "产品特写",
  "coreContent": "展示手机外观",
  "composition": "居中构图",
  "lightingType": "自然光"
}
```

**有创作意图（科技感、专业）：**
```json
{
  "shotType": "产品特写",
  "coreContent": "展示手机外观，强调科技感和专业设计",
  "composition": "三分法构图，突出产品线条",
  "lightingType": "冷色调工作室灯光，营造科技氛围",
  "colorStyle": "高对比度，蓝色调为主",
  "cameraMovement": "缓慢推进，稳定专业"
}
```

---

### 场景2：文本生成分镜

#### 4.5 用户操作流程
```
1. 用户填写创作意图：
   - 创作目标：制作一个情感短片
   - 目标受众：18-25岁的年轻人
   - 视频基调：温暖、感人、治愈

2. 用户输入文本：
   "一个女孩在咖啡馆里等人，窗外下着雨..."

3. 点击"生成分镜"
```

#### 4.6 技术实现

**文件：** `Infrastructure/AI/AIServiceManager.cs`

```csharp
public async Task<List<AiShotDescription>> GenerateShotsFromTextAsync(
    string userInput,
    Project project,  // 新增：传入项目信息
    CancellationToken ct)
{
    // 构建Prompt变量
    var variables = new Dictionary<string, string>
    {
        {"USER_INPUT", userInput},
        {"PROJECT_ID", project.Id}  // 自动注入创作意图
    };

    // 渲染Prompt（会自动注入创作意图）
    var prompt = _promptService.RenderPrompt("text_to_shots", variables);

    // 调用AI
    var result = await _aiProvider.GenerateTextAsync(prompt, ct);

    return ParseShotsFromJson(result);
}
```

#### 4.7 Prompt模板示例

**文件：** `Infrastructure/AI/Prompts/text_to_shots.txt`

```
你是一个专业的导演和编剧。

{{IF HAS_CREATIVE_INTENT}}
# 项目创作意图
本项目的创作背景：
- 创作目标：{{CREATIVE_GOAL}}
- 目标受众：{{TARGET_AUDIENCE}}
- 视频基调：{{VIDEO_TONE}}
- 核心信息：{{KEY_MESSAGE}}

请根据上述创作意图，生成符合目标的分镜脚本。
例如：
- 如果基调是"温暖、治愈"，则多使用暖色调、柔和的灯光
- 如果受众是"年轻人"，则节奏可以更快，镜头更有活力
- 如果目标是"情感短片"，则重点刻画人物情绪和细节
{{ENDIF}}

用户输入的故事描述：
{{USER_INPUT}}

请将上述故事拆分成多个分镜，每个分镜包含：
- 镜头类型、核心内容、场景设置
- 首帧和尾帧的视觉描述
- 构图、灯光、运镜方式
- 视频生成参数

输出JSON数组格式：
[
  {
    "shotNumber": 1,
    "shotType": "...",
    "coreContent": "...",
    ...
  }
]
```

#### 4.8 效果对比

**没有创作意图：**
```json
[
  {
    "shotNumber": 1,
    "shotType": "环境镜头",
    "coreContent": "咖啡馆内景",
    "lightingType": "室内灯光"
  }
]
```

**有创作意图（温暖、治愈）：**
```json
[
  {
    "shotNumber": 1,
    "shotType": "环境镜头",
    "coreContent": "咖啡馆内景，温暖的灯光营造治愈氛围",
    "lightingType": "暖色调柔和灯光，窗外雨水模糊的光影",
    "colorStyle": "暖色调，橙黄色为主",
    "composition": "景深构图，前景虚化，突出温馨感",
    "cameraMovement": "缓慢推进，营造沉浸感"
  }
]
```

---

### 场景3：图片生成

#### 4.9 技术实现

**文件：** `Infrastructure/Services/ImageGenerationService.cs`

```csharp
public async Task<string> GenerateImageAsync(
    Shot shot,
    Project project,  // 新增：传入项目信息
    bool isFirstFrame,
    CancellationToken ct)
{
    var prompt = isFirstFrame ? shot.FirstFramePrompt : shot.LastFramePrompt;

    // 如果有创作意图，增强提示词
    if (HasCreativeIntent(project))
    {
        prompt = EnhancePromptWithIntent(prompt, project);
    }

    // 调用图片生成API
    var imagePath = await _imageProvider.GenerateAsync(prompt, ct);

    return imagePath;
}

private string EnhancePromptWithIntent(string originalPrompt, Project project)
{
    var enhancements = new List<string>();

    // 根据视频基调增强提示词
    if (!string.IsNullOrWhiteSpace(project.VideoTone))
    {
        var toneMapping = new Dictionary<string, string>
        {
            {"专业", "professional, clean, minimalist"},
            {"温暖", "warm lighting, cozy atmosphere, soft colors"},
            {"科技感", "futuristic, high-tech, cyberpunk, neon lights"},
            {"治愈", "healing, peaceful, gentle, soft focus"}
        };

        if (toneMapping.ContainsKey(project.VideoTone))
        {
            enhancements.Add(toneMapping[project.VideoTone]);
        }
    }

    // 根据目标受众调整风格
    if (!string.IsNullOrWhiteSpace(project.TargetAudience))
    {
        if (project.TargetAudience.Contains("年轻人"))
        {
            enhancements.Add("vibrant, dynamic, trendy");
        }
        else if (project.TargetAudience.Contains("商务"))
        {
            enhancements.Add("professional, corporate, elegant");
        }
    }

    // 组合原始提示词和增强部分
    return $"{originalPrompt}, {string.Join(", ", enhancements)}";
}
```

---

## 五、UI实现方案

### 5.1 在左侧边栏增加"创作意图"卡片

**文件：** `App/Views/ProjectSidebarView.axaml`

```xml
<!-- 创作意图卡片 -->
<Border Background="#18181b"
        BorderBrush="#27272a"
        BorderThickness="1"
        CornerRadius="8"
        Padding="16">
    <StackPanel Spacing="12">
        <StackPanel Orientation="Horizontal" Spacing="8">
            <PathIcon Data="M..." Width="16" Height="16" Foreground="#f59e0b" />
            <TextBlock Text="创作意图"
                       FontSize="14"
                       FontWeight="SemiBold"
                       Foreground="#f5f5f5" />
        </StackPanel>

        <TextBlock Text="填写创作意图可以帮助AI更好地理解您的需求"
                   FontSize="12"
                   Foreground="#71717a"
                   TextWrapping="Wrap" />

        <!-- 创作目标 -->
        <StackPanel Spacing="6">
            <TextBlock Text="创作目标（为什么拍）"
                       FontSize="12"
                       Foreground="#a1a1aa" />
            <TextBox Text="{Binding CreativeGoal, Mode=TwoWay}"
                     Watermark="例如：制作产品宣传片"
                     Background="#1a1a1a"
                     BorderBrush="#3f3f46" />
        </StackPanel>

        <!-- 目标受众 -->
        <StackPanel Spacing="6">
            <TextBlock Text="目标受众（给谁看）"
                       FontSize="12"
                       Foreground="#a1a1aa" />
            <TextBox Text="{Binding TargetAudience, Mode=TwoWay}"
                     Watermark="例如：25-35岁的科技爱好者"
                     Background="#1a1a1a"
                     BorderBrush="#3f3f46" />
        </StackPanel>

        <!-- 视频基调 -->
        <StackPanel Spacing="6">
            <TextBlock Text="视频基调（情绪氛围）"
                       FontSize="12"
                       Foreground="#a1a1aa" />
            <ComboBox SelectedItem="{Binding VideoTone, Mode=TwoWay}"
                      Background="#1a1a1a"
                      BorderBrush="#3f3f46">
                <ComboBoxItem Content="专业、现代" />
                <ComboBoxItem Content="温暖、治愈" />
                <ComboBoxItem Content="科技感、未来" />
                <ComboBoxItem Content="轻松、幽默" />
                <ComboBoxItem Content="严肃、正式" />
                <ComboBoxItem Content="激动、热血" />
                <ComboBoxItem Content="沉思、深刻" />
            </ComboBox>
        </StackPanel>

        <!-- 保存按钮 -->
        <Button Classes="Secondary"
                HorizontalAlignment="Stretch"
                Command="{Binding SaveCreativeIntentCommand}">
            <TextBlock Text="保存意图" />
        </Button>
    </StackPanel>
</Border>
```

### 5.2 在ViewModel中增加属性和命令

**文件：** `App/ViewModels/MainViewModel.cs`

```csharp
public partial class MainViewModel : ObservableObject
{
    // 创作意图属性
    [ObservableProperty]
    private string? _creativeGoal;

    [ObservableProperty]
    private string? _targetAudience;

    [ObservableProperty]
    private string? _videoTone;

    [ObservableProperty]
    private string? _keyMessage;

    // 保存创作意图命令
    [RelayCommand]
    private async Task SaveCreativeIntent()
    {
        if (string.IsNullOrWhiteSpace(CurrentProjectId))
            return;

        try
        {
            // 更新项目的创作意图
            var project = await _projectStore.GetByIdAsync(CurrentProjectId);
            if (project != null)
            {
                project.CreativeGoal = CreativeGoal;
                project.TargetAudience = TargetAudience;
                project.VideoTone = VideoTone;
                project.KeyMessage = KeyMessage;

                await _projectStore.SaveAsync(project);

                _logger.LogInformation("创作意图已保存");
                StatusMessage = "创作意图已保存";
            }
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "保存创作意图失败");
            StatusMessage = $"保存失败：{ex.Message}";
        }
    }

    // 加载项目时，同时加载创作意图
    private async Task LoadProjectAsync(string projectId)
    {
        var project = await _projectStore.GetByIdAsync(projectId);
        if (project != null)
        {
            // 加载创作意图
            CreativeGoal = project.CreativeGoal;
            TargetAudience = project.TargetAudience;
            VideoTone = project.VideoTone;
            KeyMessage = project.KeyMessage;

            // 加载其他数据...
        }
    }
}
```

---

## 六、数据库迁移

### 6.1 创建迁移

**命令：**
```bash
dotnet ef migrations add AddCreativeIntentToProject --project Infrastructure --startup-project App
```

### 6.2 迁移代码

**文件：** `Infrastructure/Persistence/Migrations/XXXXXX_AddCreativeIntentToProject.cs`

```csharp
public partial class AddCreativeIntentToProject : Migration
{
    protected override void Up(MigrationBuilder migrationBuilder)
    {
        migrationBuilder.AddColumn<string>(
            name: "CreativeGoal",
            table: "Projects",
            type: "TEXT",
            nullable: true);

        migrationBuilder.AddColumn<string>(
            name: "TargetAudience",
            table: "Projects",
            type: "TEXT",
            nullable: true);

        migrationBuilder.AddColumn<string>(
            name: "VideoTone",
            table: "Projects",
            type: "TEXT",
            nullable: true);

        migrationBuilder.AddColumn<string>(
            name: "KeyMessage",
            table: "Projects",
            type: "TEXT",
            nullable: true);
    }

    protected override void Down(MigrationBuilder migrationBuilder)
    {
        migrationBuilder.DropColumn(name: "CreativeGoal", table: "Projects");
        migrationBuilder.DropColumn(name: "TargetAudience", table: "Projects");
        migrationBuilder.DropColumn(name: "VideoTone", table: "Projects");
        migrationBuilder.DropColumn(name: "KeyMessage", table: "Projects");
    }
}
```

### 6.3 应用迁移

**命令：**
```bash
dotnet ef database update --project Infrastructure --startup-project App
```

---

## 七、完整的数据流

### 7.1 用户填写创作意图
```
用户在UI中填写 → MainViewModel.CreativeGoal 等属性更新
→ SaveCreativeIntentCommand 执行 → 保存到数据库
```

### 7.2 AI分析时使用创作意图
```
用户点击"批量AI分析" → AiAnalysisViewModel.AIAnalyzeAll()
→ 遍历所有Shot → 调用 AIServiceManager.AnalyzeShotAsync(shot, project)
→ PromptManagementService.RenderPrompt() 自动注入创作意图
→ AI返回结果（已考虑创作意图）
```

### 7.3 图片生成时使用创作意图
```
用户点击"生成首帧" → ImageGenerationService.GenerateImageAsync(shot, project)
→ EnhancePromptWithIntent() 根据创作意图增强提示词
→ 调用图片生成API → 返回符合基调的图片
```

---

## 八、实施步骤

### 步骤1：数据模型（1小时）
- [ ] 修改 `Domain/Entities/Project.cs`，增加4个字段
- [ ] 创建数据库迁移
- [ ] 应用迁移

### 步骤2：UI实现（2小时）
- [ ] 修改 `App/Views/ProjectSidebarView.axaml`，增加创作意图卡片
- [ ] 修改 `App/ViewModels/MainViewModel.cs`，增加属性和命令
- [ ] 测试UI交互

### 步骤3：Prompt工程（3小时）
- [ ] 修改 `Infrastructure/AI/PromptManagementService.cs`，增加意图注入逻辑
- [ ] 修改所有Prompt模板，增加 `{{IF HAS_CREATIVE_INTENT}}` 部分
- [ ] 测试Prompt渲染

### 步骤4：AI服务集成（2小时）
- [ ] 修改 `Infrastructure/AI/AIServiceManager.cs`，传入 `project` 参数
- [ ] 修改 `Infrastructure/Services/ImageGenerationService.cs`，增强提示词
- [ ] 修改 `Infrastructure/Services/VideoGenerationService.cs`，调整参数

### 步骤5：测试和优化（2小时）
- [ ] 测试完整流程：填写意图 → AI分析 → 生成图片
- [ ] 对比有无意图的生成结果
- [ ] 优化Prompt模板

**总计：约10小时**

---

## 九、效果验证

### 9.1 测试用例1：科技产品宣传片

**创作意图：**
- 创作目标：制作科技产品宣传片
- 目标受众：25-35岁的科技爱好者
- 视频基调：专业、现代、充满科技感

**预期效果：**
- AI分析时，会强调产品的科技特性
- 图片生成时，会使用冷色调、高对比度
- 运镜方式会更稳定、专业

### 9.2 测试用例2：情感短片

**创作意图：**
- 创作目标：制作情感短片
- 目标受众：18-25岁的年轻人
- 视频基调：温暖、治愈

**预期效果：**
- AI分析时，会强调人物情绪和细节
- 图片生成时，会使用暖色调、柔和灯光
- 运镜方式会更缓慢、沉浸

---

## 十、总结

### 核心原理
**创作意图 = AI处理的全局上下文**

通过将创作意图注入到所有AI Prompt中，让AI在处理每个任务时都能理解：
- 为什么拍（目标）
- 给谁看（受众）
- 什么感觉（基调）

### 技术实现
1. **数据层**：在Project实体中存储创作意图
2. **Prompt层**：在所有Prompt模板中注入创作意图
3. **服务层**：在AI调用时传入项目信息
4. **UI层**：提供友好的输入界面

### 预期效果
- AI生成的内容更符合用户预期
- 视觉风格更统一
- 用户满意度提升

---

**文档生成时间**：2026-01-18
**核心结论**：创作意图不是独立功能，而是贯穿整个AI处理流程的上下文信息，通过Prompt注入实现技术挂钩。
